define(['Magento_Checkout/js/model/totals','ClassyLlama_AvaTax/js/certificates-sdk','jquery','Magento_Checkout/js/model/quote','Magento_Checkout/js/action/get-totals','Magento_Checkout/js/model/full-screen-loader','mage/storage','ClassyLlama_AvaTax/js/action/set-shipping-address','ClassyLlama_AvaTax/js/model/certificate-authentication-popup','Magento_Customer/js/customer-data','Magento_Customer/js/model/customer'],function(totals,sdk,jQuery,quote,getTotalsAction,fullScreenLoader,storage,setShippingAddress,certificateAuthenticationPopup,customerDataModel,customerModel){'use strict';return function(targetModule){var parentInitialize=targetModule.prototype.initialize;targetModule.prototype.initialize=function initialize(){parentInitialize.apply(this,arguments);this.shippingToEnabledCountry=false;this.hasUploadedCertificate=false;this.observe(['shippingToEnabledCountry','hasUploadedCertificate']);if(this.enabledCountries===void(0)){this.enabledCountries=[];}
quote.shippingAddress.subscribe(function(address){this.shippingToEnabledCountry(this.enabledCountries.indexOf(address.countryId)>=0);}.bind(this));jQuery(window.document).on('checkout.navigateTo',function(){this.hasUploadedCertificate(false);}.bind(this));};targetModule.prototype.ifShowCertificateLink=function ifShowCertificateLink(){if(this.documentManagementEnabled===false){return false;}
var amount=0,taxTotal;if(totals){taxTotal=totals.getSegment('tax');if(taxTotal){amount=taxTotal.value;}}
return amount>0;};targetModule.prototype.ifShowManageCertificateLink=function ifShowManageCertificateLink(){return customerModel.isLoggedIn();};targetModule.prototype.showNewCertificateModal=function showNewCertificateModal(){if(customerDataModel.get('customer')().firstname===void(0)){certificateAuthenticationPopup.showModal();return;}
if(this.dialogElement===void(0)){this.dialogElement=jQuery('<div class="avatax-certificate-dialog" />').appendTo('body');this.dialogElement.modal({buttons:[]});}
var onCertificateComplete=(function(){this.hasUploadedCertificate(true);this.refreshTotals();}).bind(this);this.dialogElement.empty();this.dialogElement.modal('openModal');sdk(this.dialogElement[0],{upload:true,onCertSuccess:onCertificateComplete,onManualSubmit:onCertificateComplete,onUpload:onCertificateComplete}).then(function(){var address=quote.shippingAddress();GenCert.setShipZone(address.region);GenCert.show();this.dialogElement.modal('openModal');}.bind(this))};targetModule.prototype.refreshTotals=function refreshTotals(){GenCert.hide();this.dialogElement.modal('closeModal');fullScreenLoader.startLoader();return storage.get('/rest/V1/avatax/tax/refresh').then(function(){return setShippingAddress();}).always(function(){fullScreenLoader.stopLoader();});};return targetModule;};});