define(['jquery','uiComponent','Magento_Ui/js/modal/alert','Magento_Ui/js/lib/view/utils/dom-observer'],function($,Class,alert,domObserver){'use strict';return Class.extend({defaults:{$selector:null,selector:'edit_form',container:'payment_form_tnw_authorize_cim',active:false,scriptLoaded:false,accept:null,imports:{onActiveChange:'active'}},initObservable:function(){var self=this;self.$selector=$('#'+self.selector);this._super().observe(['active','scriptLoaded']);self.$selector.off('changePaymentMethod.'+this.code).on('changePaymentMethod.'+this.code,this.changePaymentMethod.bind(this));domObserver.get('#'+self.container,function(){if(self.scriptLoaded()){self.$selector.off('submit');}});return this;},changePaymentMethod:function(event,method){this.active(method===this.code);return this;},onActiveChange:function(isActive){if(!isActive){this.$selector.off('submitOrder.'+this.code);return;}
this.disableEventListeners();window.order.addExcludedPaymentMethod(this.code);if(!this.apiLoginID||!this.clientKey){this.error($.mage.__('This payment is not available'));return;}
this.enableEventListeners();if(!this.scriptLoaded()){this.loadScript();}},loadScript:function(){var self=this,state=self.scriptLoaded;$('body').trigger('processStart');require([this.sdkUrl],function(){state(true);self.accept=window.Accept;$('body').trigger('processStop');});},error:function(message){alert({content:message});},enableEventListeners:function(){this.$selector.on('submitOrder.'+this.code,this.submitOrder.bind(this));},disableEventListeners:function(){this.$selector.off('submitOrder');this.$selector.off('submit');},setOpaqueDescriptor:function(nonce){var $container=$('#'+this.container);$container.find('[name="payment[opaqueDescriptor]"]').val(nonce);},setOpaqueValue:function(nonce){var $container=$('#'+this.container);$container.find('[name="payment[opaqueValue]"]').val(nonce);},submitOrder:function(){this.$selector.validate().form();this.$selector.trigger('afterValidate.beforeSubmit');$('body').trigger('processStop');if(this.$selector.validate().errorList.length){return false;}
var self=this,paymentData={cardData:{cardNumber:$(this.getSelector('cc_number')).val().replace(/\D/g,''),month:$(this.getSelector('expiration')).val(),year:$(this.getSelector('expiration_yr')).val(),cardCode:$(this.getSelector('cc_cid')).val()},authData:{clientKey:this.clientKey,apiLoginID:this.apiLoginID}};this.accept.dispatchData(paymentData,function(response){if(response.messages.resultCode==="Error"){var i=0;while(i<response.messages.message.length){self.error(response.messages.message[i].code+": "+response.messages.message[i].text);i=i+1;}}else{self.setOpaqueDescriptor(response.opaqueData.dataDescriptor);self.setOpaqueValue(response.opaqueData.dataValue);self.placeOrder();}});},placeOrder:function(){$('#'+this.selector).trigger('realOrder');},getSelector:function(field){return'#'+this.code+'_'+field;}});});