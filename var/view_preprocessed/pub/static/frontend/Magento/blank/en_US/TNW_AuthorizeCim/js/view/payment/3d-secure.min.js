define(['jquery','mage/translate','Magento_Checkout/js/model/quote'],function($,$t,quote){'use strict';return{config:null,cardinal:null,setConfig:function(config){this.config=config;this.config.thresholdAmount=parseFloat(config.thresholdAmount);},getCode:function(){return'verify_authorize';},load:function(){this.cardinal=window.Cardinal;this.cardinal.configure({logging:{level:'verbose'}});},validate:function(context){var self=this,state=$.Deferred(),orderNumber='ORDER-'+quote.getQuoteId(),totalAmount=quote.totals()['base_grand_total'],currencyCode=quote.totals()['base_currency_code'],billingAddress=quote.billingAddress();if(!this.isAmountAvailable(totalAmount)||!this.isCountryAvailable(billingAddress.countryId)){state.resolve();return state.promise();}
$.ajax({method:'get',url:this.config.jwtUrl,data:{'order_details':{'OrderNumber':orderNumber,'Amount':parseFloat(totalAmount).toFixed(2).replace('.',''),'CurrencyCode':currencyCode}},dataType:'json'}).done(function(responseData){try{self.cardinal.setup('init',{jwt:responseData.jwt});self.cardinal.on('payments.validated',function(data,jwt){switch(data.ActionCode){case"SUCCESS":context.addAdditionalData('ECIFlag',data.Payment.ExtendedData.ECIFlag);context.addAdditionalData('CAVV',data.Payment.ExtendedData.CAVV);state.resolve();break;case"NOACTION":state.resolve();break;case"FAILURE":case"ERROR":state.reject(data.ErrorDescription);break;}});self.cardinal.start('cca',{OrderDetails:{OrderNumber:orderNumber},Consumer:{Account:{AccountNumber:$(context.getSelector('cc_number')).val().replace(/\D/g,''),ExpirationMonth:$(context.getSelector('expiration')).val(),ExpirationYear:$(context.getSelector('expiration_yr')).val(),}}});}catch(error){state.reject(error);}}).fail(function(xhr,ajaxError){state.reject($t('Error getting JWT'));});return state.promise();},isAmountAvailable:function(amount){amount=parseFloat(amount);return amount>=this.config.thresholdAmount;},isCountryAvailable:function(countryId){var key,specificCountries=this.config.specificCountries;if(!specificCountries.length){return true;}
for(key in specificCountries){if(countryId===specificCountries[key]){return true;}}
return false;}};});